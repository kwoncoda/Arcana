services:
  mysql:
    image: mysql:8.4
    container_name: arcana-mysql
    restart: unless-stopped
    env_file:
      - ./backend/.env
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./init:/docker-entrypoint-initdb.d  # init.sql 자동실행 마운트(DB 초기화시 실행)
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -p\"$${MYSQL_ROOT_PASSWORD}\""]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: arcana-backend
    depends_on:
      mysql:
        condition: service_healthy     # DB 준비 후 시작
    env_file:
      - ./backend/.env
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
      - workspace-storage:/app/storage/workspace

volumes:
  mysql-data:
  workspace-storage:
