---
id: TASK-0013.4
type: task
title: RAG 검색 응답 포맷 및 로그 시나리오
status: draft
owner: backend
updated: 2025-10-10
---

## 1. 배경
- `/aiagent/search`는 워크스페이스 문서 기반 RAG 검색 결과를 반환한다.
- 2025-10-10 기준으로 API 응답 스키마는 `answer` 문자열만 포함한다.
- LLM은 답변 마지막 줄에 가장 관련성이 높은 문서 URL 하나만 기재하도록 프롬프트가 조정되었다.
- 백엔드에서는 유지보수를 위해 질문·답변·원본 출처 정보를 DEBUG 로그에 남긴다.

## 2. 기본 시나리오
1. 클라이언트가 `/aiagent/search`에 `{"query": "테스트 페이지임3 라는 문서가 있어?"}` 형태로 요청한다.
2. 에이전트는 하이브리드 검색(`hybrid_search_with_score`)으로 상위 문서를 수집한다.
3. 컨텍스트는 `[번호] 제목/URL/유사도 점수/본문` 블록으로 구성되며 LLM에 주입된다.
4. LLM은 답변 본문을 한국어로 작성하고, 마지막 줄에 신뢰도가 가장 높은 문서의 URL만 단독으로 표기한다.
5. 백엔드는 LLM 응답이 URL을 포함하지 않을 때 최고 점수 citation의 URL을 후속으로 추가한다.
6. 응답 본문 예시는 아래와 같다.

```json
{
  "answer": "직접적으로 제목이 \"테스트 페이지임3\"인 문서는 없습니다. 대신 \"하위 페이지 테스트임3\"라는 문서가 존재합니다 [1], 또한 \"테스트 페이지임2\" 문서의 내용에 \"하위 페이지 테스트임3\"가 언급되어 있습니다 [2].\n\nhttps://www.notion.so/3-2847a396636d80deb80ce247e080401a"
}
```

7. 동시에 DEBUG 로그에는 내부 `SearchResult` 직렬화가 기록된다.

```
RAG search response: {"question": "테스트 페이지임3 라는 문서가 있어?", "answer": "...", "citations": [{...}]}
```

## 3. 예외 시나리오
- 검색 결과가 없으면 `answer`에 "연결된 워크스페이스에서 관련 문서를 찾을 수 없습니다."를 담아 반환한다.
- Azure OpenAI 환경변수가 누락되면 500 응답과 함께 오류 메시지를 전달한다.
- LLM 호출 실패 시 "죄송합니다. 현재 답변 생성에 실패했습니다. 잠시 후 다시 시도해 주세요." 메시지를 응답한다.

## 4. 운영 체크리스트
- DEBUG 로그가 활성화되어야 질문·답변·근거 데이터가 남는다.
- LLM 프롬프트 수정 시 "마지막 줄 URL 단독 표기" 지침이 유지되는지 확인한다.
- 최고 점수 citation에 URL이 없을 경우 후처리로는 아무 URL도 추가되지 않으므로, 데이터 적재 과정에서 `page_url` 메타데이터가 채워져 있는지 점검한다.
