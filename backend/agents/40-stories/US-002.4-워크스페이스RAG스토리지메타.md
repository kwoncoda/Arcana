# 워크스페이스 RAG 스토리지 & 인덱스 메타데이터 시나리오 (Workspace RAG Storage & Metadata Sync)
**문서 버전:** 1.0
**작성일:** 2025-10-08 22:00:00 KST

---

## 1) 개요
Arcana 플랫폼은 워크스페이스 가입 시점부터 RAG 파이프라인이 안정적으로 작동하도록 워크스페이스 전용 파일 스토리지와 메타데이터를 준비해야 합니다. 이 시나리오는 회원가입으로 생성되는 워크스페이스가 즉시 디스크 상의 전용 디렉터리를 가지도록 하고, 노션 페이지 적재 이후 RAG 인덱스 메타데이터(`rag_indexes`)가 최신 상태를 유지하는 흐름을 정의합니다.

---

## 2) 선행 조건
- `init.sql`이 `rag_indexes` 테이블을 `storage_uri NOT NULL`, `index_type='chroma'`를 허용하도록 최신화돼 있습니다.
- Docker Compose가 `backend/storage/workspace` 경로를 볼륨으로 마운트하여 컨테이너 재시작에도 데이터가 유지됩니다.
- 회원가입 및 노션 동기화 API가 정상 동작하며, 워크스페이스와 노션 연동이 완료된 상태입니다.

---

## 3) 주요 컴포넌트
- `backend/utils/workspace_storage.py`: 워크스페이스 이름을 슬러그 처리하고 `/backend/storage/workspace/{slug}` 디렉터리를 생성합니다.
- `backend/routers/users.py`: 회원가입 처리 중 워크스페이스 기본 RAG 스토리지를 보장하고, `rag_indexes`에 기본 행을 준비합니다.
- `backend/rag/chroma.py`: 워크스페이스별 Chroma 컬렉션에 임베딩을 저장하며, 디렉터리를 확인·생성합니다.
- `backend/routers/notion.py`: 노션 페이지를 적재한 뒤 인덱스 메타데이터의 `storage_uri`, `object_count`, `vector_count`, `updated` 값을 갱신합니다.

---

## 4) 상세 흐름
1. 새 사용자가 회원가입하면 `users` 라우터가 워크스페이스 엔터티를 생성한 뒤 `ensure_workspace_storage()`를 호출해 전용 폴더를 만듭니다.
2. 동일 시점에 기본 RAG 인덱스 행(`name='default'`, `index_type='chroma'`, `storage_uri` 경로)을 `rag_indexes` 테이블에 생성하거나 최신화합니다.
3. 이후 `/notion/pages/pull` API가 노션 콘텐츠를 가져오고, `ChromaRAGService`가 워크스페이스 전용 디렉터리에 임베딩을 저장합니다.
4. 적재가 완료되면 `rag_indexes` 행의 `object_count`, `vector_count`, `updated` 필드를 최신값으로 갱신하여 워크스페이스 상태를 추적합니다.

---

## 5) 예외 및 오류 처리
- 워크스페이스 디렉터리 생성이 실패하면 회원가입 절차를 롤백하고 오류를 반환합니다.
- RAG 인덱스 행 생성·갱신에 실패하면 로그를 남기고 클라이언트에 서버 오류를 알립니다.
- 노션 적재 중 임베딩 또는 저장 오류가 발생하면 예외를 발생시키고, `rag_indexes`는 변경 전 상태를 유지합니다.

---

## 6) 검증 포인트
- 회원가입 직후 `backend/storage/workspace/{workspace_slug}` 경로가 존재하고, Docker 볼륨 안에 생성되는지 확인합니다.
- `rag_indexes` 테이블에 새 워크스페이스용 기본 레코드가 생성되고 `storage_uri`가 실제 경로와 일치하는지 확인합니다.
- 노션 적재 이후 `object_count`와 `vector_count` 값이 증가하며, `updated` 타임스탬프가 최신화되는지 검증합니다.

---

## 7) 후속 과제
- 워크스페이스별 다중 인덱스를 지원하기 위한 `name` 관리 전략 수립.
- RAG 인덱스 상태 모니터링 대시보드 및 알림 체계 구축.
- 장기 보존을 위한 백업/복구 스크립트 마련.
