# Google Drive 파일 포맷 변환 및 워크스페이스 저장 시나리오

## 1) 개요
Google Drive 데이터 소스가 연결된 사용자가 `/google-drive/files/pull` 엔드포인트를 호출하면, 다운로드/내보내기가 가능한 문서형 파일을 워크스페이스 스토리지에 변환된 포맷(PDF 또는 OpenXML DOCX)으로 저장하고 RAG 인덱스에 적재한다. 모든 처리 단계는 로거를 통해 기록되며, 변환된 파일에서 추출한 텍스트를 기반으로 LangChain 문서를 생성한다. OpenXML로 변환된 경우에는 문서 XML을 메타데이터에 함께 저장한다.

---

## 2) 선행 조건
- 사용자는 로그인 상태이며 `Authorization: Bearer <access_token>` 헤더를 포함한다.
- 사용자의 기본(primary) 워크스페이스가 존재하고 `googledrive` 데이터 소스가 연결되어 있다.
- `GoogleDriveOauthCredentials`가 유효한 액세스 토큰을 보유하거나 `ensure_valid_access_token`으로 자동 갱신 가능해야 한다.
- 워크스페이스 스토리지가 `ensure_workspace_storage`로 생성 가능해야 한다.

---

## 3) 엔드포인트 요약
### 3.1 `POST /google-drive/files/pull`
- **목적**: Google Drive 파일을 PDF 또는 OpenXML DOCX로 변환 후 워크스페이스 `googledrive/pdf` 디렉터리에 저장하고, 추출 텍스트를 RAG 인덱스에 적재한다. DOCX(OpenXML)로 저장된 경우 `word/document.xml` 내용도 함께 JSONL/메타데이터에 포함한다.
- **요청 헤더**: `Authorization: Bearer <access_token>`
- **성공 응답** (`200 OK`):
  ```json
  {
    "files": [
      {
        "file_id": "1Ab...",
        "name": "회의록.docx",
        "mime_type": "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
        "modified_time": "2025-10-29T02:18:01Z",
        "format": "openxml_document",
        "file_path": "/storage/acme/googledrive/pdf/회의록-1Ab....docx",
        "structured_format": "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
        "text_length": 12452
      }
    ],
    "jsonl_records": [{"file_id": "1Ab...", "chunk_index": 0, "file_path": "/storage/...", "structured_format": "application/vnd.openxmlformats-officedocument.wordprocessingml.document"}],
    "jsonl_text": "{...}\n{...}",
    "skipped_files": [{"file_id": "2Cd...", "reason": "다운로드 권한이 없습니다."}],
    "ingested_chunks": 12,
    "last_synced_at": "2025-10-28T09:00:00Z",
    "synced_at": "2025-10-30T07:42:11.123456+00:00"
  }
  ```
- **주요 검증/에러**:
  - `401 Unauthorized`: 사용자 토큰 누락 또는 만료.
  - `409 Conflict`: Google Drive 자격 증명이 연결되어 있지 않음.
  - `502 Bad Gateway`: Google Drive API 응답 오류.
  - `500 Internal Server Error`: RAG 적재 실패 또는 DB 커밋 실패.

---

## 4) 상세 흐름
1. FastAPI 라우터가 기본 워크스페이스를 확인하고 Google Drive 자격 증명을 조회한다.
2. `ensure_valid_access_token`이 액세스 토큰을 갱신하고, `DataSource.synced`로 증분 동기화 기준 시각을 가져온다.
3. `ensure_workspace_storage`가 반환한 경로 하위에 `googledrive/pdf` 디렉터리를 구성한다.
4. `fetch_authorized_text_files`가 Google Drive API를 호출해 변환 가능한 파일 목록을 가져오고, 각 파일에 대해 다음을 수행한다.
   - 다운로드 권한이 없거나 지원하지 않는 MIME 타입(예: HWP)은 `skipped_files`에 기록하고 로그에 남긴다.
   - Google Docs/Sheets/Slides는 Export API로 PDF 또는 DOCX(OpenXML)로 변환하고, Office 파일은 필요 시 Google 문서 사본을 만든 뒤 동일하게 Export한다.
   - 변환된 바이트를 워크스페이스 경로(`<storage>/<workspace>/googledrive/pdf/<정규화된-파일명-<id>>.(pdf|docx)`)에 저장한다.
   - PDF는 `pypdf.PdfReader`로 텍스트를 추출하고, DOCX(OpenXML)는 `word/document.xml`을 추출한 뒤 XML을 평문으로 변환한다.
5. `build_records_from_files`가 저장 경로, 포맷, OpenXML XML 문자열(`structured_text`)을 포함한 JSON Lines 레코드를 생성한다.
6. `build_documents_from_records`가 레코드를 LangChain `Document`로 변환하며 워크스페이스 메타데이터에 `file_path`, `structured_format`, `structured_text`를 주입한다.
7. `ChromaRAGService.replace_documents`가 기본 인덱스를 갱신하고, `collection_stats`로 페이지/벡터 수를 집계한다.
8. `RagIndex` 및 `DataSource.synced` 메타데이터를 현재 시각으로 업데이트한 뒤 DB에 커밋한다.
9. 응답 본문에 PDF 저장 경로, 텍스트 길이, JSONL, 스킵된 파일, 동기화 결과를 포함한다.

---

## 5) 데이터 및 스토리지 영향
- 워크스페이스 스토리지 내 `googledrive/pdf` 디렉터리에 PDF 또는 DOCX(OpenXML) 파일이 생성된다.
- `jsonl_records` 각 항목에 `file_path`, `structured_format`, `structured_text`(해당 시)이 포함되어 추후 추적이 가능하다.
- `RagIndex`의 `storage_uri`, `object_count`, `vector_count`, `updated`가 PDF 기반 동기화 결과로 갱신된다.
- `DataSource.synced`에 최근 동기화 시각이 저장된다.

---

## 6) 예외 및 롤백 전략
- Google Drive API 실패 시 `GoogleDriveAPIError`를 `HTTP 502`로 변환하고 동기화를 중단한다.
- PDF 변환/텍스트 추출 실패 시 해당 파일을 `skipped_files`에 기록하고 다음 파일로 진행한다.
- RAG 적재 실패 또는 DB 커밋 실패 시 트랜잭션을 롤백하고 `HTTP 500`으로 응답한다.

---

## 7) 후속 과제 및 확장 포인트
- PDF 외의 이미지/스캔 문서를 위한 OCR 파이프라인 도입 검토.
- 사용자 지정 다운로드 경로 또는 파일명 규칙을 설정할 수 있는 옵션 추가.
- 증분 동기화 히스토리를 프론트엔드에서 시각화할 수 있는 로그 API 확장.