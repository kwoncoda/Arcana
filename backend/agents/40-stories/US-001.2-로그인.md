# 로그인 시나리오 사양서 (Login API Spec)
**문서 버전:** 1.0  
**작성일:** 2025-10-02 11:40:38 KST

---

## 1) 개요
사용자 자격 증명을 검증하고, 성공 시 **Access Token**과 **Refresh Token**을 발급합니다.  
추가로 성공 시 `users.last_login`을 현재 시각으로 갱신합니다.

> 본 문서는 회원가입/조직 생성 흐름을 포함하지 않습니다. 해당 내용은 별도의 *회원가입 시나리오 사양서*를 참고하세요.

---

## 2) 엔드포인트
- **Method**: `POST`
- **Path**: `/api/users/login`  
- **성공 상태코드**: `200 OK`
- **실패 상태코드**: `401 Unauthorized` (인증 실패를 단일 코드로 통합)
- **응답 헤더(실패 시 권장)**: `WWW-Authenticate: Bearer`

---

## 3) 요청 스키마
### Body (JSON)
| 필드 | 타입 | 필수 | 설명 |
|---|---|---|---|
| `id` | string | ✅ | 로그인 ID |
| `password` | string | ✅ | 평문 비밀번호 |

#### 예시
```json
{
  "id": "gildong",
  "password": "Secret#123"
}
```

---

## 4) 응답 스키마
### 성공 (200)
```json
{
  "access_token": "<JWT or opaque token>",
  "refresh_token": "<JWT or opaque token>"
}
```
- 토큰 생성은 코드 내 `create_access_token(subject=str(user.idx))`, `create_refresh_token(subject=str(user.idx))`를 사용

### 실패 (401)
```json
{
  "detail": "아이디 또는 비밀번호가 올바르지 않습니다."
}
```
- 실패 시 헤더 예시: `WWW-Authenticate: Bearer`

---

## 5) 처리 흐름 (요약)
1. **사용자 조회**: `select(User).where(User.id == payload.id)`
2. **비밀번호 검증**:  
   - 사용자 존재 시: 저장된 해시와 검증  
   - 사용자 미존재 시: **더미 해시**(`_DUMMY_HASH`)로 검증 → 실행 시간 균등화
3. **인증 실패 통일 응답**:  
   - 존재하지 않는 계정, 비밀번호 불일치, 비활성 계정 → 모두 `401 Unauthorized` + 동일 메시지
4. **마지막 로그인 갱신**: `user.last_login = datetime.utcnow()` 후 `commit()`  
   (에러 시 `rollback()` 하고 계속 진행 가능)
5. **토큰 발급**: Access/Refresh Token 생성 후 반환

---

## 6) 보안 설계 포인트
- **타이밍 공격 완화**: `_DUMMY_HASH = hash_password("haha")`를 프로세스 시작 시 1회 생성하여,  
  미존재 계정도 비밀번호 검증을 실행해 응답 시간 편차를 줄임
- **실패 응답 통일**: 존재 여부·활성 상태 노출 방지 위해 `401`과 동일 메시지로 응답
- **WWW-Authenticate 헤더**: OAuth2 호환성 및 클라이언트 표준화 지원
- **입력 정규화(권장)**: `payload.id.strip()` 등 공백 제거, 필요 시 소문자 변환 정책 통일

---

## 7) 데이터베이스 사이드 이펙트
- **UPDATE**: `users.last_login` = `CURRENT_UTC`  
- **트랜잭션 처리**: `commit()` 실패 시 `rollback()` 수행. 토큰 발급에는 영향 없음(정책에 따라 커밋 실패 시 로그인 자체를 실패 처리할 수도 있음).

---

## 8) 예시 호출
### 성공
```bash
curl -X POST https://api.example.com/users/login \
  -H "Content-Type: application/json" \
  -d '{
    "id": "gildong",
    "password": "Secret#123"
  }' -i
# HTTP/1.1 200 OK
# {
#   "access_token": "...",
#   "refresh_token": "..."
# }
```

### 실패 (잘못된 자격 증명)
```bash
curl -X POST https://api.example.com/users/login \
  -H "Content-Type: application/json" \
  -d '{
    "id": "gildong",
    "password": "wrong"
  }' -i
# HTTP/1.1 401 Unauthorized
# WWW-Authenticate: Bearer
# {
#   "detail": "아이디 또는 비밀번호가 올바르지 않습니다."
# }
```

---

## 9) 에러 매핑
| 상황 | 상태코드 | 메시지 | 비고 |
|---|---|---|---|
| 사용자 없음 | 401 | 아이디 또는 비밀번호가 올바르지 않습니다. | 더미 해시 검증 수행 |
| 비밀번호 불일치 | 401 | 아이디 또는 비밀번호가 올바르지 않습니다. |  |
| 비활성 사용자 | 401 | 아이디 또는 비밀번호가 올바르지 않습니다. | 403 대신 401로 통일 |
| DB 커밋 실패(선택) | 200 또는 500 | 정책에 따름 | 커밋 실패 시 롤백 후 토큰 발급 유지/중단 결정 |

---


---

## 11) 테스트 케이스 (샘플)
- [성공] 존재하는 사용자 + 올바른 비밀번호 → 200, 토큰 존재, last_login 갱신
- [실패] 존재하지 않는 사용자 → 401, 동일 메시지, 헤더 Bearer
- [실패] 비밀번호 불일치 → 401, 동일 메시지
- [실패] 비활성 사용자 → 401, 동일 메시지
- [경합] 동시 로그인 시 last_login 업데이트 충돌 없이 성공
- [예외] DB 커밋 실패 시 롤백 수행, 정책에 맞는 응답

---

## 12) 변경 이력
- v1.0: 로그인 실패 통일(401), 더미 해시 도입, last_login 갱신 및 토큰 발급
