# 회원가입 시나리오 사양서 (Signup API Spec)
**문서 버전:** 1.0  
**작성일:** 2025-10-02 11:17:16 KST

---

## 1) 개요
신규 사용자를 생성하고, 요청의 `type` 값에 따라 **개인 워크스페이스** 또는 **조직 워크스페이스**를 보장합니다.  
조직 가입의 경우 조직명으로 조직을 **조회/생성**, 멤버십을 생성하고, 해당 조직에 **단일 조직 워크스페이스**를 **존재하면 재사용 / 없으면 생성**합니다.

> **비고**: 본 시나리오는 *외부 데이터 소스(`data_sources`), 노션 OAuth 등*은 다루지 않습니다. (후속 연동 시점에 lazy-create 권장)

---

## 2) 엔드포인트
- **Method**: `POST`
- **Path**: `/api/users/register`  
- **성공 상태코드**: `201 Created`
- **응답 본문**: 현재 구현은 **빈 응답**(바디 없음)을 반환합니다.

---

## 3) 요청 스키마
### Body (JSON)
| 필드 | 타입 | 필수 | 설명 |
|---|---|---|---|
| `id` | string | ✅ | 로그인용 사용자 ID (UNIQUE) |
| `email` | string | ✅ | 이메일 (UNIQUE) |
| `nickname` | string | ✅ | 닉네임 (UNIQUE) |
| `password` | string | ✅ | 평문 비밀번호 (서버에서 PBKDF2-SHA256으로 해시 저장) |
| `type` | string | ✅ | 워크스페이스 유형: `"personal"` 또는 `"organization"` |
| `organization_name` | string | ⛔️ | `type="organization"`인 경우 **필수** (조직명 UNIQUE) |

#### 예시 - 개인
```json
{{
  "id": "gildong",
  "email": "gildong@example.com",
  "nickname": "홍길동",
  "password": "Secret#123",
  "type": "personal"
}}
```

#### 예시 - 조직
```json
{{
  "id": "minji",
  "email": "minji@example.com",
  "nickname": "민지",
  "password": "Another#123",
  "type": "organization",
  "organization_name": "아르카나"
}}
```

---

## 4) 검증 및 에러 매핑
요청 처리 중 다음 케이스에 대해 **즉시 검증** 또는 **DB 고유성 제약 위반**을 포착하여 대응합니다.

### 사전 중복 검사 (exists)
- `409 Conflict` : `id` 이미 존재
- `460` : `email` 이미 존재 (비표준 코드)
- `461` : `nickname` 이미 존재 (비표준 코드)

### 필드 검증
- `464` : `type` 값이 유효하지 않음 (`personal|organization` 이외)
- `462` : `type="organization"`인데 `organization_name` 누락

### DB 고유성 제약 위반 (`flush`/`commit` 중)
- `463` : 사용자/조직 생성 단계에서 고유성 위반 등으로 실패
- `400 Bad Request` : 커밋 단계 등 기타 처리 중 일반 오류

> 비표준 상태코드(460~464)는 OpenAPI `responses`로 문서화됨.

---

## 5) 처리 흐름
### 5.1 개인(`type="personal"`) 흐름
1. 사용자 중복/유효성 검증
2. `users` insert (비밀번호는 PBKDF2-SHA256 해시로 저장) → `flush()`로 `user.idx` 확보
3. `workspaces` insert
   - `type = "personal"`
   - `owner_user_idx = user.idx`
   - `name = "{{nickname or id or email_local}}'s workspace"`
4. `commit()` 후 `201 Created`

### 5.2 조직(`type="organization"`) 흐름
1. 사용자 중복/유효성 검증 + 조직명 필수 검증
2. `users` insert → `flush()`로 `user.idx` 확보
3. 조직 조회
   - 있으면 재사용
   - 없으면 `organizations` insert → `flush()`로 `organization.idx` 확보
4. `memberships` insert (`user_idx`, `organization_idx`, `role="member"`)
5. 조직 워크스페이스 보장
   - `workspaces`에서 `type="organization"` & `organization_idx=...`로 조회
   - 없으면 생성: `name = "{{organization.name}}'s workspace"`
6. `commit()` 후 `201 Created`

> **제약 조건**:  
> - `workspaces`: `(type, organization_idx)` UNIQUE → 조직당 조직 WS 1개  
> - `workspaces`: `(type, owner_user_idx)` UNIQUE → 유저당 개인 WS 1개  
> - `organizations.name` UNIQUE (본 시나리오에서는 조직명 유니크)

---

## 6) DB 사이드 이펙트
### 쓰기 대상 테이블
- `users`
- `organizations` (조직 가입 시, 없으면 생성)
- `memberships` (조직 가입 시 항상 생성 시도)
- `workspaces` (개인/조직 각각 1개 보장)

### 트랜잭션
- `flush()`로 FK용 PK를 선점한 뒤, 모든 insert를 마치고 최종 `commit()`
- `IntegrityError` 발생 시 `rollback()` 후 위의 에러 매핑에 따라 응답

### 동시성/경합
- 동일 `id/email/nickname` 혹은 동일 `organization_name`에 대한 경합 발생 가능
- 고유성 제약으로 안전하게 차단되며, 적절한 상태코드(409/460/461/463 등)로 매핑

---

## 7) 응답
- **성공**: `201 Created` (현재 구현은 **바디 없음**)
- **실패**: 위 에러 매핑에 따른 상태코드 + `{{"detail": "..."}}`

> 필요 시 성공 응답에 `user/workspace/organization` 요약을 JSON으로 포함하도록 변경 가능.

---

## 8) 예시 호출
### 8.1 개인 가입 (성공)
```bash
curl -X POST https://api.example.com/users/register   -H "Content-Type: application/json"   -d '{
    "id": "gildong",
    "email": "gildong@example.com",
    "nickname": "홍길동",
    "password": "Secret#123",
    "type": "personal"
  }' -i
# HTTP/1.1 201 Created
```

### 8.2 조직 가입 (기존 조직 재사용)
```bash
curl -X POST https://api.example.com/users/register   -H "Content-Type: application/json"   -d '{
    "id": "minji",
    "email": "minji@example.com",
    "nickname": "민지",
    "password": "Another#123",
    "type": "organization",
    "organization_name": "아르카나"
  }' -i
# HTTP/1.1 201 Created
```

### 8.3 에러 예시 - 이메일 중복
```bash
# 이미 존재하는 이메일
# → 460 (비표준)
HTTP/1.1 460
{
  "detail": "이미 사용 중인 이메일입니다."
}
```

---

## 9) 의존 모델/열람 참고
- `User(idx, id, email, nickname, password_hash, active, created, last_login)`
- `Organization(idx, name)`  // `name` UNIQUE
- `Membership(idx, user_idx, organization_idx, role)`
- `Workspace(idx, type, name, owner_user_idx, organization_idx)`
- `WorkspaceType`: `personal | organization`

---

## 10) 보안/기타
- 비밀번호는 서버에서 PBKDF2-SHA256으로 해시하여 저장
- API는 HTTPS 전제
- 비표준 코드(460~464)는 API 컨슈머와의 합의 필요 (문서화 완료)

---

## 11) 변경 이력
- v1.0 (초안): 회원가입 + 워크스페이스/조직/멤버십 보장, 201 빈 응답
