# 사용자 외부 도구 연동 현황 조회 시나리오 (User External Tool Connection Status)


## 1) 개요
사용자가 로그인한 상태에서 자신의 기본 워크스페이스에 연결된 외부 도구(예: Notion, Google Drive 등)의 연동 현황을 조회하는 흐름을 확인한다. 본 시나리오는 `/users/connections` 엔드포인트를 호출해 프론트엔드가 연결 상태를 시각화할 수 있는 데이터 구조를 제공합니다.

---

## 2) 선행 조건
- 사용자는 인증(access token)을 소지하고 있어야 하며, 요청 헤더에 포함해야 합니다.
- 사용자는 최소 한 개 이상의 워크스페이스에 속해 있어야 하며, 기본(primary) 워크스페이스가 지정되어 있어야 합니다.
- 워크스페이스별로 `DataSource` 및 `Credentials` 레코드가 존재하거나 자동 생성될 수 있는 상태여야 합니다.

---

## 3) 엔드포인트 요약
### 3.1 `GET /users/connections`
- **목적**: 인증된 사용자의 기본 워크스페이스에서 활성화된 데이터 소스(외부 도구)의 연결 현황 조회
- **요청 헤더**: `Authorization: Bearer <access_token>`
- **성공 응답** (`200 OK`):
  ```json
  {
    "connections": [
      {
        "provider": "notion",
        "status": "connected",
        "last_synced_at": "2025-10-01T07:45:12Z"
      }
    ]
  }
  ```
- **주요 검증/에러**:
  - `401 Unauthorized`: 토큰 누락 또는 만료
  - `404 Not Found`: 기본 워크스페이스를 찾을 수 없는 경우
  - `500 Internal Server Error`: 데이터 소스 질의 중 예기치 못한 오류

---

## 4) 상세 흐름
1. 백엔드는 `get_current_user` 의존성을 통해 사용자 정보를 확인합니다.
2. `resolve_user_primary_workspace(user, db)` 헬퍼를 호출해 사용자의 기본 워크스페이스를 가져옵니다.
3. 워크스페이스의 데이터 소스(`DataSource`)를 조회하고, 각 소스에 연결된 자격 증명(`Credentials`)의 상태를 확인합니다.
4. 각 데이터 소스에 대해 `provider`, `status`, `last_synced_at` 등을 정규화한 `ExternalToolStatus`로 매핑합니다.
5. 매핑된 연결 리스트를 `ExternalToolConnectionsResponse` 구조로 직렬화해 반환합니다.

---

## 5) 데이터 모델 영향
- `DataSource`: 워크스페이스와 외부 도구 간 연결 정보를 보유하며, 연동 상태(`status`) 필드를 통해 연결 여부를 표현합니다.
- `Credentials`/`NotionOauthCredentials`: 각 데이터 소스의 인증 토큰과 만료 정보를 관리하며, 마지막 동기화 시각을 기록합니다.

---

## 6) 예외 및 롤백 전략
- 기본 워크스페이스가 해지되었거나 권한이 없는 경우 `404` 또는 `403`을 반환하고 연결 목록은 제공하지 않습니다.
- 데이터 소스 조회 중 오류가 발생하면 예외를 로깅하고 `500` 오류를 반환합니다.
- 연결 목록은 읽기 전용이므로 트랜잭션 롤백은 필요하지 않으나, DB 세션 오류 시 즉시 종료하고 상위 레이어에서 재시도를 유도합니다.

---

## 7) 후속 과제 및 확장 포인트
- 프론트엔드에서 각 외부 도구별 아이콘과 상태 메시지를 매핑할 수 있도록 `display_name`, `icon_url` 속성 추가 검토
- 연결 상태를 실시간으로 업데이트하기 위한 웹소켓 또는 폴링 전략 설계
- 최근 동기화 작업의 실패 원인을 노출하기 위한 `error_message` 필드 확장