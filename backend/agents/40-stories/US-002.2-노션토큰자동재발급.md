# 노션 액세스 토큰 자동 재발급 시나리오 (Auto Refresh Notion Access Token)
**문서 버전:** 1.0
**작성일:** 2025-02-14 18:00:00 KST

---

## 1) 개요
Notion과 연동된 워크스페이스에서 API 호출 시 access_token 만료를 감지하고, 저장된 refresh_token으로 자동 재발급하여 요청을 이어가는 흐름을 정의한다. 프런트엔드 혹은 백엔드 서비스 계층은 `ensure_valid_access_token`을 통해 토큰 유효성을 검증하며, 실패 시 사용자를 재연동 화면으로 유도한다.

---

## 2) 선행 조건
- 워크스페이스가 Notion OAuth 연동을 완료하여 `NotionOauthCredentials`에 access_token, refresh_token, expires가 저장되어 있어야 한다.
- 환경 변수 `NOTION_CLIENT_ID`, `NOTION_CLIENT_SECRET`, `NOTION_REDIRECT_URI`가 설정되어야 한다.
- 백엔드는 `backend/notions/notion.py`의 리프레시 유틸을 import할 수 있어야 한다.

---

## 3) 핵심 유즈케이스
1. **API 호출 전 토큰 검증**
   - 서비스 계층은 `get_credential_by_workspace_id`로 워크스페이스 자격 증명을 로드한다.
   - `ensure_valid_access_token(db, cred)`를 호출해 access_token 만료 여부를 확인한다.
   - 만료 임박 시 `refresh_access_token`이 내부적으로 실행되어 토큰을 재발급한다.

2. **재발급 실패 대응**
   - refresh_token 부재 또는 만료로 Notion API가 오류를 반환하면, 예외를 상위 계층으로 전달한다.
   - 호출부는 자격 증명을 `disconnected` 상태로 전환하고, 사용자에게 Notion 재연결을 요구하는 메시지를 노출한다.

3. **리프레시 후 요청 재시도**
   - 성공적으로 재발급된 access_token은 `apply_oauth_tokens`를 통해 DB에 커밋된다.
   - 새 토큰으로 Notion API 호출을 즉시 재시도한다. 동일 요청에서 리프레시를 반복하지 않으며, 이후 호출에서는 최신 `expires` 기준으로 재평가한다.

---

## 4) 흐름 상세
1. 호출부가 워크스페이스 식별자로 `NotionOauthCredentials`를 조회한다.
2. `_REFRESH_SAFETY_WINDOW`(90초) 내에 만료될 예정이면 `should_refresh_token`이 True를 반환한다.
3. `refresh_access_token`이 Notion `/oauth/token` 엔드포인트에 `grant_type=refresh_token`으로 요청한다.
4. 응답으로 받은 새 토큰 정보를 `apply_oauth_tokens`가 병합하고, `DataSource.status`는 유지한다.
5. 갱신된 access_token을 사용해 원래 API 호출을 수행한다.

---

## 5) 예외 및 롤백 전략
- Notion 토큰 재발급 API가 401/400을 반환하면 예외를 기록하고 사용자 재인증을 유도한다.
- DB 커밋 실패 시 재발급한 토큰이 저장되지 않으므로, 호출부는 재시도 전에 크레덴셜을 재조회한다.
- refresh_token이 존재하지 않으면 즉시 재로그인 플로우로 전환한다.

---

## 6) 성공 기준
- 만료 혹은 만료 예정 access_token으로도 사용자 개입 없이 API 호출이 성공적으로 재시도된다.
- 로그에는 토큰 재발급 시점과 실패 사유가 명확히 남는다.
- 사용자에게는 refresh_token 만료 등의 치명적 오류가 발생했을 때만 재연동 안내가 노출된다.

---

## 7) 후속 과제
- refresh_token 교체 주기를 모니터링하고, 장기 미사용 시 자격 증명을 자동으로 해지하는 정책을 마련한다.
- 다중 워커 환경에서 토큰 리프레시 경쟁 상태를 방지하기 위한 분산 락 전략을 검토한다.
