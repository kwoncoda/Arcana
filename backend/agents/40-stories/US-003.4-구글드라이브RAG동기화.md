# Google Drive 파일 RAG 동기화 시나리오 (Google Drive File Sync to RAG)

## 1) 개요
Google Drive에 연동된 사용자가 `/google-drive/files/pull` 엔드포인트를 호출해 접근이 허용된 드라이브 파일을 워크스페이스 RAG 스토리지로 동기화하는 흐름을 다룬다. 파일은 텍스트로 정규화된 뒤 청크 단위로 LangChain 문서가 생성되어 크로마 기반 벡터 스토어에 저장된다.

---

## 2) 선행 조건
- 사용자는 로그인 상태이며 `Authorization: Bearer <access_token>` 헤더를 포함한다.
- 사용자의 기본(primary) 워크스페이스가 존재하고 `googledrive` 타입 데이터 소스가 연결되어 있다.
- `GoogleDriveOauthCredentials` 레코드가 `access_token`, `refresh_token`을 보유하고 있으며, `ensure_valid_access_token` 헬퍼를 통해 만료 토큰이 자동으로 갱신될 수 있다.
- 워크스페이스 스토리지 경로가 `ensure_workspace_storage`로 생성 가능해야 한다.

---

## 3) 엔드포인트 요약
### 3.1 `POST /google-drive/files/pull`
- **목적**: Google Drive에서 다운로드 및 Export 권한이 있는 파일을 수집하고 워크스페이스 기본 RAG 인덱스에 적재한다.
- **요청 헤더**: `Authorization: Bearer <access_token>`
- **성공 응답** (`200 OK`):
  ```json
  {
    "files": [
      {
        "file_id": "1Ab...",
        "name": "회의록.docx",
        "mime_type": "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
        "modified_time": "2025-10-29T02:18:01Z",
        "format": "text",
        "text_length": 12452
      }
    ],
    "jsonl_records": [
      {
        "file_id": "1Ab...",
        "chunk_index": 0,
        "text": "청크 텍스트 ..."
      }
    ],
    "jsonl_text": "{...}\n{...}",
    "skipped_files": [
      {
        "file_id": "2Cd...",
        "mime_type": "application/pdf",
        "reason": "PDF 파일은 현재 지원하지 않습니다."
      }
    ],
    "ingested_chunks": 12,
    "last_synced_at": "2025-10-28T09:00:00Z",
    "synced_at": "2025-10-30T07:42:11.123456+00:00"
  }
  ```
- **주요 검증/에러**:
  - `401 Unauthorized`: 사용자 토큰 누락 또는 만료.
  - `409 Conflict`: Google Drive 자격 증명이 연결되어 있지 않음.
  - `502 Bad Gateway`: Google Drive API 응답 오류.
  - `500 Internal Server Error`: RAG 적재 실패 또는 DB 커밋 실패.

---

## 4) 상세 흐름
1. FastAPI 라우터는 `get_current_user`와 `resolve_user_primary_workspace`를 사용해 사용자의 기본 워크스페이스를 확인한다.
2. `_ensure_google_resources` 및 `get_connected_google_credential`로 `googledrive` 데이터 소스와 사용자 자격증명을 조회한다.
3. `ensure_valid_access_token`이 만료된 토큰을 갱신하고, `data_sources.synced`를 통해 마지막 동기화 시각을 가져온다.
4. `fetch_authorized_text_files`가 Google Drive API를 호출하여 권한 있는 파일 목록을 수집하고, 확장/Export 가능한 MIME 타입만 텍스트로 변환한다.
   - `.hwp`나 PDF 등 미지원 파일은 `skipped_files`에 이유와 함께 기록된다.
   - Google Docs/Sheets/Slides는 Export API를 통해 `text/plain` 또는 `text/csv`로 변환된다.
5. `build_records_from_files`가 텍스트를 `_DEFAULT_CHUNK_SIZE`(800 토큰)와 `_DEFAULT_CHUNK_OVERLAP_RATIO`(10%) 기준으로 청크 분할해 JSON Lines 레코드를 생성한다.
6. `build_documents_from_records`가 레코드를 LangChain `Document`로 변환하며 워크스페이스/파일 메타데이터(`chunk_id`, `page_url`, `format` 등)를 주입한다.
7. `ChromaRAGService.replace_documents`가 워크스페이스 기본 인덱스(`DEFAULT_RAG_INDEX_NAME`)를 갱신하고, `collection_stats`로 벡터/페이지 수를 계산한다.
8. RAG 인덱스 메타데이터(`RagIndex`)와 데이터 소스(`DataSource.synced`)를 현재 시각으로 업데이트한 뒤 DB에 커밋한다.
9. 응답 본문에는 동기화된 파일 정보, 청크 JSONL, 스킵된 파일, 청크 수, 마지막 동기화 시각이 포함된다.

---

## 5) 데이터 모델 영향
- `DataSource.synced`: Google Drive 동기화 완료 시각을 저장한다.
- `RagIndex`: `storage_uri`, `object_count`, `vector_count`, `updated` 필드가 크로마 인덱스 메타데이터로 갱신된다.
- `GoogleDriveOauthCredentials`: `ensure_valid_access_token`을 통해 갱신된 토큰과 `connected_at` 정보가 유지된다.

---

## 6) 예외 및 롤백 전략
- Google Drive API 호출 실패 시 `GoogleDriveAPIError`를 HTTP 502로 변환하고 처리 중단.
- RAG 적재 실패 시 `HTTP 500`을 반환하며 DB 커밋 전에 예외 발생 시 세션이 롤백된다.
- DB 커밋 중 예외가 발생하면 롤백 후 사용자에게 저장 실패 메시지를 전달한다.

---

## 7) 후속 과제 및 확장 포인트
- PDF, 이미지 등 비텍스트 파일을 위한 Vision OCR 파이프라인 연동 검토.
- 사용자 지정 청크 크기 및 중복 허용 비율 설정을 위한 파라미터 확장.
- 증분 동기화 결과를 대시보드에 시각화하기 위한 프론트엔드 이벤트 스트림 설계.
