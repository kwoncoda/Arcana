# 워크스페이스 AI 에이전트 오케스트레이션 시나리오 사양서 (Workspace AI Agent Orchestration)
**문서 버전:** 1.0
**작성일:** 2025-10-15 10:00:00 KST

---

## 1) 개요
Arcana 사용자가 `/aiagent/search` 엔드포인트를 호출했을 때, 단순 검색만 수행할지 혹은 검색 결과를 바탕으로 새로운 노션 페이지를 생성할지를 LangGraph 기반 에이전트가 스스로 판단하고 실행하는 시나리오를 정의합니다. 이 시나리오는 검색, 문서 생성, 노션 연동 흐름을 하나의 그래프로 묶어 사용자 요청 의도에 맞는 결과(답변 혹은 노션 페이지)를 제공합니다.

---

## 2) 선행 조건
- 사용자는 Arcana에 로그인한 상태이며 JWT 토큰을 보유합니다.
- 사용자의 워크스페이스에 대해 다음 정보가 유효합니다.
  - 워크스페이스 식별자(`workspace_idx`), 이름, RAG 스토리지 경로(`storage_uri`).
  - Arcana DB에 노션 연동 자격 증명이 저장되어 있어야 노션 페이지 생성이 가능합니다.
- 환경 변수
  - `CM_AZURE_OPENAI_*`: 답변 및 생성 LLM 호출용 Azure OpenAI 설정.
  - `EM_AZURE_OPENAI_*`: 검색 후보군 생성을 위한 임베딩 모델 설정.
  - `NOTION_CLIENT_ID`, `NOTION_CLIENT_SECRET`: 노션 OAuth.
- 워크스페이스의 RAG 인덱스가 갱신되어 있어야 하며, 검색 시 접근 가능한 상태여야 합니다.

---

## 3) 주요 컴포넌트
- `backend/routers/aiagent.py`
  - `/aiagent/search` 라우트: 사용자 입력, 워크스페이스 컨텍스트, DB 세션을 LangGraph 오케스트레이터에 전달합니다.
- `backend/ai_module/orchestrator.py`
  - `WorkspaceAgentOrchestrator`: LangGraph 그래프를 구성해 `decide → search/generate → create_page` 흐름을 제어합니다.
  - 그래프 상태(`AgentState`)에 질문, 의사결정 결과, RAG 컨텍스트, 생성 문서, 노션 페이지 참조를 저장합니다.
- `backend/ai_module/decision.py`
  - `DecisionAgent`: LLM을 호출해 사용자가 검색만 원하는지, 문서를 생성하고 싶은지 판단하고 추가 지시문을 추출합니다.
- `backend/ai_module/rag_search.py`
  - `WorkspaceRAGSearchAgent`: LangChain 러너블 체인으로 RAG 답변을 생성하며, 문서 생성용 RAG 컨텍스트도 제공합니다.
- `backend/ai_module/document_generation.py`
  - `DocumentGenerationAgent`: 결정된 지시문과 RAG 컨텍스트를 기반으로 새로운 문서(제목+본문)를 작성합니다.
- `backend/notions/notionCreate.py`
  - `create_page_from_markdown`: Arcana DB에 저장된 자격 증명을 사용해 노션 페이지를 생성하고 참조 정보를 반환합니다.

---

## 4) 상세 흐름
1. 클라이언트가 `/aiagent/search`에 요청을 전송합니다.
   - Body 필드: `query`는 필수. `mode_hint`나 `options` 같은 메타데이터는 선택(추후 확장용).
2. 라우터는 `get_workspace_context`로 워크스페이스 정보를 조회하고, SQLAlchemy 세션과 함께 `WorkspaceAgentOrchestrator.run`을 호출합니다.
3. 그래프 **결정 노드(decide)**
   - `DecisionAgent`가 질문을 분석하여 다음 중 하나를 반환합니다.
     - `search`: 검색만 수행.
     - `generate_with_rag`: RAG 문맥을 참고해 문서 생성.
     - `generate_without_rag`: 완전히 새로운 문서 생성.
   - 추가적으로 생성 지시문(`instructions`)을 함께 전달합니다.
4. 결정에 따라 그래프는 아래 분기를 택합니다.
   - **검색(search)**: `WorkspaceRAGSearchAgent.search`가 실행되어 RAG 답변과 인용 정보를 생성하고 그래프가 종료됩니다.
   - **RAG 기반 생성(generate_with_rag)**:
     1. `retrieve_for_generation`으로 검색 컨텍스트와 인용 정보를 준비합니다.
     2. `DocumentGenerationAgent.generate`가 컨텍스트와 지시문을 활용해 문서를 작성합니다.
     3. `create_page_from_markdown`이 노션 페이지를 생성합니다.
   - **독립 생성(generate_without_rag)**:
     1. 검색 단계 없이 바로 `DocumentGenerationAgent.generate`가 실행됩니다.
     2. 생성된 문서를 노션 페이지로 게시합니다.
5. 그래프 종료 시 `AgentExecutionResult`가 반환되어 API 응답 본문이 구성됩니다.
   - `mode`: "search" 또는 "generate".
   - `result`: 검색 시 RAG 답변, 생성 시 안내 메시지 및 인용 정보.
   - `notion_page_*`: 문서 생성 시 노션 페이지 ID/URL.

---

## 5) 예외 처리 및 롤백
- 노션 자격 증명이 없거나 만료된 경우 `NotionCredentialError`를 반환하고 그래프를 종료합니다.
- RAG 검색 결과가 비어 있어도 그래프는 기본 안내 메시지를 포함한 응답을 제공합니다.
- LLM 호출 실패 시 적절한 예외를 로깅하고 500 오류를 반환합니다.
- LangGraph 실행 중 예외가 발생하면 그래프 실행을 중단하고 API가 에러를 응답하도록 합니다.

---

## 6) 검증 포인트
- 결정 에이전트가 검색/생성 요청을 정확히 분류하는지 QA 시나리오 작성.
- 검색 분기에서 RAG 응답이 기존 검색 API와 동일한 스키마를 유지하는지 확인.
- 문서 생성 분기에서 노션 페이지가 실제로 생성되고, 응답에 `notion_page_id`, `notion_page_url`이 포함되는지 검증.
- RAG 기반 생성 시 인용 정보가 노션 페이지 내용에 반영되거나 후처리할 수 있도록 응답에 전달되는지 확인.
- 사용자가 잘못된 워크스페이스를 요청할 때 적절한 인증/인가 에러가 발생하는지 점검.

---

## 7) 후속 과제
- LangGraph 상태에 사용자 선호도(예: 기본 모드, 템플릿)를 저장해 맞춤형 흐름을 제공하는 옵션 추가.
- 의사결정 모델에 사용자의 과거 의도 히스토리를 반영해 더 정확한 분기를 수행하는 기능 연구.
