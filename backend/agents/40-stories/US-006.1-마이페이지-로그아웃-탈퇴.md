# 마이페이지 로그아웃 및 회원탈퇴 시나리오
**문서 버전:** 1.0
**작성일:** 2025-10-02

---

## 1) 개요
마이페이지에서 사용자가 세션을 안전하게 종료하거나, 계정을 완전히 삭제할 때 필요한 프런트/백엔드 흐름을 정의한다. 토큰은 브라우저 저장소에서 즉시 제거되며, 백엔드는 워크스페이스 유형에 맞춰 연동/저장 데이터를 정리한 뒤 트랜잭션으로 계정을 삭제한다.

---

## 2) 엔드포인트
- **로그아웃(클라이언트 전용)**: 토큰/닉네임을 `sessionStorage`/`localStorage`에서 모두 삭제 후 `/login` 리다이렉션.
- **회원탈퇴**
  - **Method**: `DELETE`
  - **Path**: `/api/users/me`
  - **성공 상태코드**: `204 No Content`
  - **실패 상태코드**: `401 Unauthorized`, `500 Internal Server Error`

---

## 3) 기본 흐름
1. 사용자가 마이페이지에서 로그아웃 또는 회원탈퇴 버튼을 클릭한다.
2. 로그아웃은 즉시 토큰/닉네임을 삭제하고 로그인 페이지로 이동한다.
3. 회원탈퇴는 확인 대화상자 이후 `DELETE /api/users/me`를 호출한다.
4. 백엔드는 현재 사용자를 조회해 워크스페이스 유형별로 단일 트랜잭션 내부에서 정리하고, 커밋 성공 후에만 파일 스토리지를 제거한다.
   - **personal**: 데이터 소스 연계 테이블(구글 드라이브 스냅샷/SyncState·OAuth, 노션 OAuth)과 `rag_indexes`를 모두 삭제하고 데이터 소스와 워크스페이스를 제거한다. 커밋 후 워크스페이스 스토리지(벡터 DB 포함)를 정리한다.
   - **organization**: 노션/구글 연동 자격 증명을 유저 기준으로 제거하고, 멤버십만 삭제한다. 조직 및 워크스페이스는 남겨둔다.
5. 트랜잭션이 성공하면 사용자 행을 삭제하고 `204` 응답을 반환한다.
6. 프런트엔드는 성공 응답 시 저장소를 정리하고 "탈퇴되었습니다" 전용 메시지를 표시한 뒤 `/login`으로 리다이렉션한다.

---

## 4) 예외/오류 처리
- 인증 실패 또는 토큰 만료 시 인터셉터가 토큰을 제거하고 로그인 페이지로 이동한다.
- 탈퇴 트랜잭션이 실패하면 즉시 롤백하고 오류 로그를 남긴 뒤 `500` 메시지를 반환한다.
- 회원탈퇴 처리 중 서버 오류가 발생하면 오류 메시지를 화면에 표시한다.

---

## 5) 완료 조건
- 로그아웃 시 모든 토큰과 닉네임 정보가 브라우저 저장소에서 제거된다.
- 회원탈퇴 요청 후 연동 자격 증명 및 멤버십이 제거된다.
- personal 사용자는 연계 테이블/데이터 소스/`rag_indexes`/워크스페이스가 삭제되고, 워크스페이스 스토리지 데이터가 정리된 상태여야 한다.
- organization 사용자는 멤버십·연동 정보만 제거되고 기존 조직/워크스페이스는 유지된다.
- 프런트엔드가 성공적으로 로그인 페이지로 이동한다.
