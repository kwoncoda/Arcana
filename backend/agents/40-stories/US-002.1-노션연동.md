# 노션 OAuth 연동 시나리오 사양서 (Connect Notion Workspace)
**문서 버전:** 1.0
**작성일:** 2025-10-05 14:00:00 KST

---

## 1) 개요
워크스페이스 사용자가 노션 계정을 OAuth로 연결하여 **데이터 소스 및 자격 증명**을 자동 생성/업데이트하는 흐름을 정의합니다. 해당 시나리오는 `/notion/connect`에서 권한 부여 URL을 발급받고, `/notion/oauth/callback`에서 토큰을 저장하여 상태를 `connected`로 전환하는 전체 과정을 포함합니다.

> **참고**: OAuth `state`는 인메모리 캐시에 저장되므로, 운영 환경에서는 Redis 등 외부 스토리지로 확장해야 합니다.

---

## 2) 선행 조건
- 환경 변수 `NOTION_CLIENT_ID`, `NOTION_CLIENT_SECRET`, `NOTION_REDIRECT_URI`가 설정되어 있어야 합니다.
- 백엔드에 `notion-client` 패키지가 설치되어 있어야 합니다.
- 사용자는 서비스에 로그인한 상태이며, 연결 대상 워크스페이스 식별자(`workspace_id`)를 알고 있어야 합니다.

---

## 3) 엔드포인트 요약
### 3.1 `POST /notion/connect`
- **목적**: Notion OAuth 권한 부여 URL 생성
- **요청 Body**: `{ "workspace_id": string }`
- **성공 응답** (`200 OK`): `{ "authorize_url": string }`
- **주요 검증/에러**:
  - `400 Bad Request`: `workspace_id` 누락 또는 유효하지 않음
  - `404 Not Found`: 워크스페이스 미존재
  - `500 Internal Server Error`: OAuth 설정값 누락 등 서버 내부 오류

### 3.2 `GET /notion/oauth/callback`
- **목적**: Notion에서 전달된 `code`와 `state`를 검증하여 토큰 저장
- **요청 Query**: `code`, `state`
- **성공 응답** (`200 OK`): `{ "message": "Notion workspace connected" }`
- **주요 검증/에러**:
  - `400 Bad Request`: `code/state` 누락, 만료된 `state`
  - `401 Unauthorized`: 토큰 교환 실패 (잘못된 client secret 등)
  - `404 Not Found`: `state`에 매핑된 워크스페이스 미존재
  - `500 Internal Server Error`: 토큰 저장 중 알 수 없는 오류

---

## 4) 상세 흐름
### 4.1 `/notion/connect`
1. 입력으로 받은 `workspace_id`로 내부 워크스페이스를 조회합니다.
2. `_ensure_notion_resources(workspace)`를 호출하여 **데이터 소스 및 자격 증명 레코드**를 준비합니다.
3. OAuth `state`를 생성하고 인메모리 캐시에 저장합니다.
4. `NotionOAuthClient` 유틸을 통해 권한 부여 URL을 생성하여 응답으로 반환합니다.

### 4.2 `/notion/oauth/callback`
1. 쿼리 파라미터의 `code`, `state`를 검증하고 캐시에서 일치하는 워크스페이스를 조회합니다.
2. Notion API에 토큰 교환을 요청하여 access/refresh 토큰을 획득합니다.
3. `apply_oauth_tokens(credentials, token_payload)`를 호출하여 `NotionOauthCredentials`에 토큰과 연결 상태(`connected`)를 저장합니다.
4. 연동이 완료되면 `DataSource` 상태를 최신 정보로 갱신하고 JSON 메시지를 반환합니다.

---

## 5) 데이터 모델 영향
- `NotionOauthCredentials`: 워크스페이스별 OAuth 토큰, 만료 시각, 연결 상태(`connected`/`disconnected`) 저장
- `DataSource`: 노션 데이터 소스 항목 생성 및 자격 증명과 매핑
- 기타 연관 엔터티(사용자, 워크스페이스)는 읽기 전용 접근만 수행합니다.

---

## 6) 예외 및 롤백 전략
- 토큰 교환 실패 또는 저장 과정에서 오류 발생 시, 자격 증명 상태를 `disconnected`로 유지하고 오류를 반환합니다.
- 캐시된 `state`는 성공/실패 여부와 관계없이 단일 사용 후 삭제합니다.
- DB 트랜잭션 실패 시 롤백을 수행하고, 재시도는 사용자가 `/notion/connect`부터 다시 시작합니다.

---

## 7) 후속 과제 및 확장 포인트
- 인메모리 `state` 저장소를 Redis 등 외부 캐시로 이전하여 서버 재시작 시에도 유효성을 유지합니다.
- 콜백 응답을 RedirectResponse로 확장하여 프론트엔드 페이지로 이동시키는 UX 향상을 고려합니다.
- 토큰 만료 시 갱신(refresh) 로직과 백그라운드 동기화 작업을 추가하여 데이터 최신성을 보장합니다.