# 대시보드 채팅 로딩 지속 및 응답 복원 시나리오
**문서 버전:** 1.0  
**작성일:** 2025-02-12

---

## 1) 개요
사용자가 대시보드에서 AI 질문을 전송한 뒤 다른 화면으로 이동해도 로딩 상태가 사라지지 않고, 백엔드 응답이 완료되면 대시보드로 돌아왔을 때 답변이 그대로 표시되는 흐름을 정의한다. 싱글 페이지 내 라우팅 변화가 빈번해도 질문/응답 맥락을 잃지 않는 것이 목표다.

---

## 2) 선행 조건
- 사용자는 로그인 상태이며 액세스 토큰을 보유한다.
- `/api/aiagent/search` 엔드포인트가 정상 동작한다.
- 동일 탭 내 라우팅으로만 이동하며, 로컬 스토리지 접근이 가능하다.

---

## 3) 기본 흐름
1. **질문 전송** – 사용자가 대시보드 채팅 입력창에 질문을 전송하면 메시지와 로딩 상태가 `localStorage`에 함께 저장된다.
2. **페이지 이동** – 사용자가 다른 메뉴(예: 마이페이지)로 이동해도 저장된 상태 덕분에 대시보드 컴포넌트 언마운트 시 로딩 표시가 소멸되지 않는다.
3. **백엔드 응답 완료** – 기존 요청이 완료되면 응답 메시지가 동일한 저장소에 기록되고, 저장 시 커스텀 이벤트가 브로드캐스트된다.
4. **대시보드 복귀** – 사용자가 대시보드로 돌아오면 초기 마운트 시 저장된 채팅 상태를 불러와 이전 질문/로딩/응답을 그대로 복원한다.
5. **로딩 표시 유지** – 복귀 시 아직 응답이 오지 않았다면 스피너와 "<질문> 처리 중" 안내가 계속 노출된다.
6. **완료 표시** – 응답이 이미 저장돼 있으면 스트리밍 UI가 즉시 메시지를 렌더링하고 로딩 상태를 해제한다.

---

## 4) 예외 및 복구
- **요청 취소**: 사용자가 로딩 중 정지 버튼을 눌러 Abort 시 저장된 상태의 로딩 플래그와 대기 질의를 제거해 스피너 잔류를 방지한다.
- **인증 만료**: 응답이 401인 경우 토큰을 정리하고 로컬 저장된 로딩 상태를 해제한 뒤 로그인 페이지로 이동한다.
- **파싱 오류**: 저장된 JSON 파싱 실패 시 빈 채팅 상태로 초기화하고 콘솔에 원인을 남긴다.

---

## 5) 관련 파일 및 포인트
- 상태 저장/복원: `frontend/my-react-app/src/components/MainDashboard.jsx` – `readChatState`, `writeChatState`, `persistChatState`를 통해 로컬 스토리지와 UI를 동기화.
- 사용자 경험: 로딩 중 질문을 함께 노출해 사용자가 어떤 요청이 처리 중인지 알 수 있도록 `LoadingHint` 추가.
