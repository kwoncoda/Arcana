# 프런트엔드 액세스 토큰 재발급 및 재시도 시나리오
**문서 버전:** 1.0
**작성일:** 2025-02-11

---

## 1) 개요
공통 axios 클라이언트를 사용하는 프런트엔드가 보호된 API 호출 중 액세스 토큰 만료를 감지하고, 리프레시 토큰으로 재발급한 뒤 원 요청을 재시도하는 흐름을 정리한다. 세션 단위 저장소 사용, 로그인/로그아웃 시 토큰 정리, 실패 시 사용자 경험을 포함한다.

---

## 2) 사전 조건
- 사용자가 로그인 또는 회원가입을 완료해 `access_token`, `refresh_token`이 브라우저 저장소에 보관되어 있다.
- 토큰 저장소는 `sessionStorage` 우선이며, 초기 접근 시 `localStorage`에 남아 있는 토큰을 회수해 세션으로 이동한다.
- `/api/users/token/refresh` 엔드포인트가 유효하며, 응답에 새 액세스/리프레시 토큰이 모두 포함된다.
- 모든 보호된 API 호출은 `api/client.js`에서 생성한 공통 axios 인스턴스를 사용한다.

---

## 3) 기본 흐름
1. **요청 준비** – 클라이언트가 저장소에서 액세스 토큰을 읽어 `Authorization: Bearer <token>` 헤더에 자동 첨부한다.
2. **응답 확인** – 응답이 401이 아니면 그대로 반환한다. 401이면 인터셉터가 재발급 절차로 진입한다.
3. **재발급 시도**
   - 저장된 리프레시 토큰이 없거나, 이미 재시도를 한 요청이라면 즉시 토큰을 모두 삭제하고 `/login`으로 이동한다.
   - 리프레시 토큰이 존재하면 `/api/users/token/refresh`로 POST 요청을 보내 새 토큰 쌍을 수신한다.
4. **저장 및 재전송** – 새 토큰을 저장소에 기록한 뒤, 실패했던 원 요청을 최대 한 번 재전송한다. 재전송 시 새 액세스 토큰을 헤더에 넣는다.
5. **실패 처리** – 재전송 결과가 여전히 401이거나 재발급 요청이 실패하면, 토큰 저장소를 완전히 비우고 `/login`으로 리디렉션한다.

---

## 4) 예외 및 사용자 경험
- **네트워크 오류**: 재발급 호출이 네트워크 문제로 실패하면 로그인 페이지로 이동해 사용자가 다시 인증하도록 안내한다.
- **동시 탭 경쟁**: 현재는 탭 간 동기화가 없으므로 여러 탭에서 재발급이 동시 시도될 수 있다. 후속 개선으로 브로드캐스트 채널 동기화를 고려한다.
- **저장소 보안**: 세션 범위 저장소를 우선 사용해 브라우저 종료 시 토큰이 정리되도록 하며, 로그아웃 시 `localStorage`와 `sessionStorage`를 모두 초기화한다.

---

## 5) 관련 파일 및 후속 과제
- 클라이언트/저장소 구현: `frontend/my-react-app/src/api/client.js`, `frontend/my-react-app/src/api/authStorage.js`
- 주요 진입점 적용: `MainDashboard.jsx`, `LoginPage.jsx`, `RegisterPage.jsx`, `GoogleOAuthCallback.jsx`, `NotionOAuthCallback.jsx`, `NotionConnectPage.jsx`, `MyPage.jsx`
- 후속 개선: 재시도 backoff, 베이스 URL 환경 설정, 탭 간 토큰 변경 브로드캐스트 처리.
